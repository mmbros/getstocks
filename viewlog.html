<html>
	<head>
<meta charset="utf-8">
<title>GetStock log viewer</title>
<style type="text/css">
svg {
  font-family: "Helvetica Neue", Helvetica;
	  border: 1px solid red;
}
.success {
	fill: blue;
}
.error {
	fill: red;
}
.skip {
	fill: gray;
}

.line {
  fill: none;
  stroke: #000;
  stroke-width: 2px;
}
</style>
	</head>
	<body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

var data =  [
{"level":"info","msg":"PROGRAM START","time":"2017-02-08T09:14:52.642620495+01:00"},
{"level":"info","msg":"SUCCESS","scraper":"www.eurotlx.com","scraper_inst":0,"stock":"BMPS 15/19 EM1 2.0","stock_date":"07-02-2017","stock_price":"90,68","time":"2017-02-08T09:14:52.713840926+01:00","time_end":"2017-02-08T09:14:52.71381364+01:00","time_start":"2017-02-08T09:14:52.648517354+01:00"},
{"level":"info","msg":"SUCCESS","scraper":"finanza.repubblica.it","scraper_inst":0,"stock":"BTP 3.75 AGO 2021","stock_date":"07/02/2017","stock_price":"112,900","time":"2017-02-08T09:14:53.011997713+01:00","time_end":"2017-02-08T09:14:53.011965086+01:00","time_start":"2017-02-08T09:14:52.650608959+01:00"},
{"level":"info","msg":"SKIP","scraper":"finanza.repubblica.it","scraper_inst":0,"stock":"BMPS 15/19 EM1 2.0","stock_date":"","stock_price":"","time":"2017-02-08T09:14:53.012206811+01:00","time_end":"2017-02-08T09:14:53.012195344+01:00","time_start":"2017-02-08T09:14:53.012191358+01:00"},
{"level":"info","msg":"SKIP","scraper":"www.milanofinanza.it","scraper_inst":0,"stock":"BTP 3.75 AGO 2021","stock_date":"","stock_price":"","time":"2017-02-08T09:14:53.012486959+01:00","time_end":"2017-02-08T09:14:53.012474883+01:00","time_start":"2017-02-08T09:14:52.64967466+01:00"},
{"level":"info","msg":"SUCCESS","scraper":"www.teleborsa.it","scraper_inst":0,"stock":"ANIMA TR 2017 C4 2 P","stock_date":"03/02/2017","stock_price":"5,26","time":"2017-02-08T09:14:53.086761501+01:00","time_end":"2017-02-08T09:14:53.086742873+01:00","time_start":"2017-02-08T09:14:52.645232732+01:00"},
{"level":"info","msg":"SKIP","scraper":"www.milanofinanza.it","scraper_inst":1,"stock":"ANIMA TR 2017 C4 2 P","stock_date":"","stock_price":"","time":"2017-02-08T09:14:53.089102857+01:00","time_end":"2017-02-08T09:14:53.089083633+01:00","time_start":"2017-02-08T09:14:52.651953394+01:00"},
{"level":"info","msg":"SUCCESS","scraper":"www.borse.it","scraper_inst":0,"stock":"ANIMA TRA 19 GLOB2 P","stock_date":"03/02/2017","stock_price":"5,0400","time":"2017-02-08T09:14:53.110784837+01:00","time_end":"2017-02-08T09:14:53.110775689+01:00","time_start":"2017-02-08T09:14:52.647051589+01:00"},
{"level":"info","msg":"SUCCESS","scraper":"www.milanofinanza.it","scraper_inst":2,"stock":"ANIMA TRA 19 GLOB2 P","stock_date":"03/02/17 1.00.00","stock_price":"5,04","time":"2017-02-08T09:14:53.123673478+01:00","time_end":"2017-02-08T09:14:53.123664198+01:00","time_start":"2017-02-08T09:14:52.651879268+01:00"},
{"level":"info","msg":"SUCCESS","scraper":"www.milanofinanza.it","scraper_inst":1,"stock":"ANIMA CED AP 22 1 P","stock_date":"03/02/17 1.00.00","stock_price":"10,017","time":"2017-02-08T09:14:53.52638927+01:00","time_end":"2017-02-08T09:14:53.526376701+01:00","time_start":"2017-02-08T09:14:53.089223809+01:00"},
{"level":"info","msg":"SUCCESS","scraper":"www.milanofinanza.it","scraper_inst":0,"stock":"ANIMA T 2021 GLB PT","stock_date":"03/02/17 1.00.00","stock_price":"5,147","time":"2017-02-08T09:14:53.52877358+01:00","time_end":"2017-02-08T09:14:53.528761472+01:00","time_start":"2017-02-08T09:14:53.012652238+01:00"},
{"level":"info","msg":"SKIP","scraper":"www.morningstar.it","scraper_inst":0,"stock":"ANIMA T 2021 GLB PT","stock_date":"","stock_price":"","time":"2017-02-08T09:14:53.529342093+01:00","time_end":"2017-02-08T09:14:53.529333346+01:00","time_start":"2017-02-08T09:14:52.648034263+01:00"},
{"level":"info","msg":"SKIP","scraper":"www.morningstar.it","scraper_inst":0,"stock":"ANIMA CED AP 22 1 P","stock_date":"","stock_price":"","time":"2017-02-08T09:14:53.529423361+01:00","time_end":"2017-02-08T09:14:53.529416838+01:00","time_start":"2017-02-08T09:14:53.529414328+01:00"},
{"level":"info","msg":"SUCCESS","scraper":"www.milanofinanza.it","scraper_inst":2,"stock":"ANIMA CED AP 21 2 P","stock_date":"03/02/17 1.00.00","stock_price":"10,16","time":"2017-02-08T09:14:53.545805993+01:00","time_end":"2017-02-08T09:14:53.545792193+01:00","time_start":"2017-02-08T09:14:53.123740959+01:00"},
{"level":"info","msg":"SKIP","scraper":"www.borse.it","scraper_inst":0,"stock":"ANIMA CED AP 21 2 P","stock_date":"","stock_price":"","time":"2017-02-08T09:14:53.551920136+01:00","time_end":"2017-02-08T09:14:53.551908368+01:00","time_start":"2017-02-08T09:14:53.110851064+01:00"},
{"level":"info","msg":"SKIP","scraper":"www.morningstar.it","scraper_inst":0,"stock":"ANIMA CED AP 21 2 P","stock_date":"","stock_price":"","time":"2017-02-08T09:14:53.552266714+01:00","time_end":"2017-02-08T09:14:53.545978328+01:00","time_start":"2017-02-08T09:14:53.529655108+01:00"},
{"level":"info","msg":"SUCCESS","scraper":"www.borse.it","scraper_inst":0,"stock":"ANIMA TRA 19 PLUS2 P","stock_date":"03/02/2017","stock_price":"5,3550","time":"2017-02-08T09:14:53.975398923+01:00","time_end":"2017-02-08T09:14:53.975383567+01:00","time_start":"2017-02-08T09:14:53.551988936+01:00"},
{"level":"info","msg":"SKIP","scraper":"www.borse.it","scraper_inst":0,"stock":"ANIMA CED AP 22 1 P","stock_date":"","stock_price":"","time":"2017-02-08T09:14:53.975586889+01:00","time_end":"2017-02-08T09:14:53.975577242+01:00","time_start":"2017-02-08T09:14:53.975573023+01:00"},
{"level":"info","msg":"SKIP","scraper":"www.borse.it","scraper_inst":0,"stock":"ANIMA T 2021 GLB PT","stock_date":"","stock_price":"","time":"2017-02-08T09:14:53.975661494+01:00","time_end":"2017-02-08T09:14:53.975653168+01:00","time_start":"2017-02-08T09:14:53.97564106+01:00"},
{"level":"info","msg":"SKIP","scraper":"www.borse.it","scraper_inst":0,"stock":"BMPS 15/19 EM1 2.0","stock_date":"","stock_price":"","time":"2017-02-08T09:14:53.97571857+01:00","time_end":"2017-02-08T09:14:53.975711208+01:00","time_start":"2017-02-08T09:14:53.975708997+01:00"},
{"level":"info","msg":"SKIP","scraper":"www.teleborsa.it","scraper_inst":0,"stock":"ANIMA TRA 19 PLUS2 P","stock_date":"","stock_price":"","time":"2017-02-08T09:14:53.975724884+01:00","time_end":"2017-02-08T09:14:53.97571117+01:00","time_start":"2017-02-08T09:14:53.086971915+01:00"},
{"level":"info","msg":"PROGRAM FINISH","time":"2017-02-08T09:14:53.975859841+01:00"},
]

function getWorkerName(scraper, inst) {
	return scraper + "-" + inst;
}

function Worker(scraper, inst){
	this.scraper = scraper;
	this.inst = inst;
	this.jobs = [];

}
Worker.prototype.addJob = function(job) {
	this.jobs.push(job);
}


var workers = {}
var program_time_start, program_time_finish;

for (i=0; i<data.length; i++){
	d = data[i];
	/*
	if ("scraper" in d) {
		var t1 = new Date(d.time_start);
		var t2 = new Date(d.time_end);
		var elapsed = t2.getTime()-t1.getTime();

		console.log(t1, t2, elapsed);
	}
	*/

	if ("scraper" in d) {
		var wname = getWorkerName(d.scraper, d.scraper_inst);
		if (!(wname in workers)) {
			workers[wname] = new Worker(d.scraper, d.scraper_inst);
		}
		workers[wname].addJob(d);
	} else if (d.msg == "PROGRAM START") {
		program_time_start = (new Date(d.time)).getTime();
	} else if (d.msg == "PROGRAM FINISH") {
		program_time_finish = (new Date(d.time)).getTime();
	}

}


var wnames = Object.keys(workers).sort();
console.log(wnames);
var totWorkers = wnames.length;
for (var i=0; i<totWorkers; i++) {
	console.log(workers[wnames[i]]);
}
var tmin = 0,
	tmax = 0;
for (var w=0; w<totWorkers; w++) {
	var worker = workers[wnames[w]];
	for (var j=0; j<worker.jobs.length; j++){
		var job = worker.jobs[j];
		var t1 = (new Date(job.time_start)).getTime();
		var t2 = (new Date(job.time_end)).getTime();
		if (t1<tmin || tmin==0){
			tmin = t1;
		}
		if (t2>tmax || tmax==0){
			tmax = t2;
		}
	}
}

console.log("program_time_start", program_time_start);
console.log("program_time_finish", program_time_finish);

console.log("tmin", tmin);
console.log("tmax", tmax);

// ----------------------------------------------------------------------------


var m = [20, 20, 30, 20],  // margins [0:top, 1:right, 2:bottom, 3:left]
	w = 800 - m[1] - m[3], // inner width
	h = 400 - m[0] - m[2]; // inner height


var DY = 10;

// domain limits
// x: from left to right
// y: from top to bottom !!!
var xmin = tmin,
	xmax = tmax,
	ymin = 0,
	ymax = DY * totWorkers;

xmin = program_time_start;
xmax = program_time_finish;

// xs and ys scales
var xs = d3.scaleLinear().domain([xmin, xmax]).range([0, w]),
    ys = d3.scaleLinear().domain([ymin, ymax]).range([0, h]);

console.log("ymax", ymax);
console.log("ys(DY)", ys(DY));


// rounded rect radius
var rectRx =15,
	rectRy = ys(DY)/2;

var svg = d3.select("body").append("svg")
    .attr("width", w + m[1] + m[3])
    .attr("height", h + m[0] + m[2])
  .append("g")
    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");


// append rounded rect
function rrect(className, x, y, w, h) {
	svg.append("rect")
		.classed(className, true)
		.attr("rx", rectRx)
		.attr("ry", rectRy)
		.attr("x", xs(x))
		.attr("y", ys(y))
		.attr("width", xs(xmin+w))
		.attr("height", ys(ymin+h));
}


// https://github.com/d3/d3-scale/blob/master/README.md#schemeCategory20
// var color = d3.scaleOrdinal(d3.schemeCategory10);

for (var w=0; w<totWorkers; w++) {
	var worker = workers[wnames[w]];
	for (var j=0; j<worker.jobs.length; j++){
		var job = worker.jobs[j];

		var t1 = (new Date(job.time_start)).getTime();
		var t2 = (new Date(job.time_end)).getTime();
//		console.log("t1", t1, "t2", t2, "elapsed", t2-t1);

		var x = t1, y = DY*(w+0.2), dx=t2-t1, dy=DY*0.6;
//		console.log("x", x, "y", y, "dx", dx, "dy", dy);
		var className = "success";
		if (job.level == "error"){
			className = "error";
		} else if (job.msg == "SKIP"){
			className = "skip";
		}
		if (dx > 0){
			rrect(className, x, y, dx, dy);
			svg.append("text")
				.attr("x", xs(x)+8)
				.attr("y", ys(y+4))
				.attr("font-family", "sans-serif")
				.attr("font-size", "10px")
				.attr("text-anchor", "left")
				.attr("fill", "white")
				.text(job.stock);
		}

	}

	svg.append("text")
		.attr("x", 0)
		.attr("y", ys(y-1))
		.attr("font-family", "sans-serif")
		.attr("font-size", "10px")
		.attr("text-anchor", "left")
		.attr("fill", "black")
		.text(wnames[w]);
}


// ------------------------

</script>
	</body>
</html>
