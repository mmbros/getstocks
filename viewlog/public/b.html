<html>
	<head>
<meta charset="utf-8">
<title>GetStock log viewer</title>
<style type="text/css">
svg {
  font-family: "Helvetica Neue", Helvetica;
	  border: 1px solid red;
}
.success {
	stroke-width: 4px;
	stroke: black;
}
.error {
	stroke-width: 4px;
	stroke: red;
}
.skip {

	stroke-width: 0px;
}

.line {
  fill: none;
  stroke: #000;
  stroke-width: 2px;
}
</style>
	</head>
	<body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
var data = {
	"start":"2017-02-19T21:44:18.974559583+01:00",
	"finish":"2017-02-19T21:44:20.280584959+01:00",
	"events":[
		{"level":"info","msg":"SUCCESS","time":"2017-02-19T21:44:19.340691987+01:00","time_start":"2017-02-19T21:44:18.978691981+01:00","time_end":"2017-02-19T21:44:19.340673956+01:00","scraper":"www.milanofinanza.it","scraper_inst":0,"stock":"BTP 3.75 AGO 2021","stock_date":"17/02/17 18.02.17","stock_price":"112,98"},
		{"level":"info","msg":"SUCCESS","time":"2017-02-19T21:44:19.494628122+01:00","time_start":"2017-02-19T21:44:18.978477734+01:00","time_end":"2017-02-19T21:44:19.494594691+01:00","scraper":"www.teleborsa.it","scraper_inst":0,"stock":"ANIMA TR 2017 C4 2 P","stock_date":"10/02/2017","stock_price":"5,257"},
		{"level":"info","msg":"SUCCESS","time":"2017-02-19T21:44:19.5698199+01:00","time_start":"2017-02-19T21:44:18.978586424+01:00","time_end":"2017-02-19T21:44:19.569727643+01:00","scraper":"www.eurotlx.com","scraper_inst":0,"stock":"BMPS 15/19 EM1 2.0","stock_date":"08-02-2017","stock_price":"90,68"},
		{"level":"info","msg":"SKIP","time":"2017-02-19T21:44:19.570550717+01:00","time_start":"2017-02-19T21:44:18.97839834+01:00","time_end":"2017-02-19T21:44:19.570438168+01:00","scraper":"finanza.repubblica.it","scraper_inst":0,"stock":"BMPS 15/19 EM1 2.0"},
		{"level":"info","msg":"SKIP","time":"2017-02-19T21:44:19.570890146+01:00","time_start":"2017-02-19T21:44:19.57087859+01:00","time_end":"2017-02-19T21:44:19.570888626+01:00","scraper":"finanza.repubblica.it","scraper_inst":0,"stock":"BTP 3.75 AGO 2021"},
		{"level":"info","msg":"SUCCESS","time":"2017-02-19T21:44:19.653982115+01:00","time_start":"2017-02-19T21:44:19.341005326+01:00","time_end":"2017-02-19T21:44:19.653973035+01:00","scraper":"www.milanofinanza.it","scraper_inst":0,"stock":"ANIMA T 2021 GLB PT","stock_date":"10/02/17 1.00.00","stock_price":"5,152"},
		{"level":"info","msg":"SKIP","time":"2017-02-19T21:44:19.654074082+01:00","time_start":"2017-02-19T21:44:19.654055823+01:00","time_end":"2017-02-19T21:44:19.654057781+01:00","scraper":"www.milanofinanza.it","scraper_inst":0,"stock":"ANIMA TR 2017 C4 2 P"},
		{"level":"info","msg":"SUCCESS","time":"2017-02-19T21:44:19.741817598+01:00","time_start":"2017-02-19T21:44:18.98055157+01:00","time_end":"2017-02-19T21:44:19.741782282+01:00","scraper":"www.morningstar.it","scraper_inst":0,"stock":"ANIMA CED AP 22 1 P","stock_date":"10/02/2017","stock_price":"10,045"},
		{"level":"info","msg":"SKIP","time":"2017-02-19T21:44:19.742088179+01:00","time_start":"2017-02-19T21:44:19.741978339+01:00","time_end":"2017-02-19T21:44:19.742061461+01:00","scraper":"www.morningstar.it","scraper_inst":0,"stock":"ANIMA T 2021 GLB PT"},
		{"level":"info","msg":"SUCCESS","time":"2017-02-19T21:44:19.992531015+01:00","time_start":"2017-02-19T21:44:19.654115742+01:00","time_end":"2017-02-19T21:44:19.992518069+01:00","scraper":"www.milanofinanza.it","scraper_inst":0,"stock":"ANIMA TRA 19 GLOB2 P","stock_date":"10/02/17 1.00.00","stock_price":"5,043"},
		{"level":"info","msg":"SKIP","time":"2017-02-19T21:44:19.9926156+01:00","time_start":"2017-02-19T21:44:19.992574759+01:00","time_end":"2017-02-19T21:44:19.992610144+01:00","scraper":"www.milanofinanza.it","scraper_inst":0,"stock":"ANIMA CED AP 22 1 P"},
		{"level":"info","msg":"SKIP","time":"2017-02-19T21:44:19.992770475+01:00","time_start":"2017-02-19T21:44:18.979503299+01:00","time_end":"2017-02-19T21:44:19.992761153+01:00","scraper":"www.borse.it","scraper_inst":0,"stock":"ANIMA TRA 19 GLOB2 P"},
		{"level":"info","msg":"SUCCESS","time":"2017-02-19T21:44:20.085102168+01:00","time_start":"2017-02-19T21:44:19.494871376+01:00","time_end":"2017-02-19T21:44:20.085090231+01:00","scraper":"www.teleborsa.it","scraper_inst":0,"stock":"ANIMA TRA 19 PLUS2 P","stock_date":"10/02/2017","stock_price":"5,36"},
		{"level":"info","msg":"SKIP","time":"2017-02-19T21:44:20.085166474+01:00","time_start":"2017-02-19T21:44:20.08515962+01:00","time_end":"2017-02-19T21:44:20.085161662+01:00","scraper":"www.teleborsa.it","scraper_inst":0,"stock":"BMPS 15/19 EM1 2.0"},
		{"level":"info","msg":"SUCCESS","time":"2017-02-19T21:44:20.280109752+01:00","time_start":"2017-02-19T21:44:19.992636401+01:00","time_end":"2017-02-19T21:44:20.280071281+01:00","scraper":"www.milanofinanza.it","scraper_inst":0,"stock":"ANIMA CED AP 21 2 P","stock_date":"10/02/17 1.00.00","stock_price":"10,134"}
	]}

function getWorkerName(scraper, inst) {
	return scraper + "-" + inst;
}

function Worker(scraper, inst){
	this.scraper = scraper;
	this.inst = inst;
	this.jobs = [];

}
Worker.prototype.addJob = function(job) {
	this.jobs.push(job);
}


var program_time_start = (new Date(data.start)).getTime();
var program_time_finish = (new Date(data.finish)).getTime();
console.log("program_time_start", program_time_start);
console.log("program_time_finish", program_time_finish);


var workers={}, stocks={}, stocks_len=0;
for (i=0; i<data.events.length; i++){
	var e = data.events[i];
	var wname = getWorkerName(e.scraper, e.scraper_inst);
	if (!(wname in workers)) {
		workers[wname] = new Worker(e.scraper, e.scraper_inst);
	}
	workers[wname].addJob(e);

	if (!(e.stock in stocks)){
		stocks[e.stock] = stocks_len++;
	}
}


var wnames = Object.keys(workers).sort();
console.log(wnames);
var totWorkers = wnames.length;

console.log(stocks);

// ----------------------------------------------------------------------------


var m = [20, 20, 30, 20],  // margins [0:top, 1:right, 2:bottom, 3:left]
	w = 800 - m[1] - m[3], // inner width
	h = 400 - m[0] - m[2]; // inner height


var svg = d3.select("body").append("svg")
    .attr("width", w + m[1] + m[3])
    .attr("height", h + m[0] + m[2])
  .append("g")
    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");
var DY = 10;

// domain limits
// x: from left to right
// y: from top to bottom !!!
var xmin = program_time_start,
	xmax = program_time_finish,
	ymin = 0,
	ymax = DY * totWorkers;

// xs and ys scales
var xs = d3.scaleLinear().domain([xmin, xmax]).range([0, w]),
    ys = d3.scaleLinear().domain([ymin, ymax]).range([0, h]);

console.log("ymax", ymax);
console.log("ys(DY)", ys(DY));


// rounded rect radius
var rectRx =15,
	rectRy = ys(DY)/2;

var svg = d3.select("body").append("svg")
    .attr("width", w + m[1] + m[3])
    .attr("height", h + m[0] + m[2])
  .append("g")
    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");


// append rounded rect
function rrect(className, x, y, w, h) {
	svg.append("rect")
		.classed(className, true)
		.attr("rx", rectRx)
		.attr("ry", rectRy)
		.attr("x", xs(x))
		.attr("y", ys(y))
		.attr("width", xs(xmin+w))
		.attr("height", ys(ymin+h));
}

// append rounded rect
function rrectColor(className, color, x, y, w, h) {
	svg.append("rect")
		.classed(className, true)
		.attr("fill", color)
		.attr("rx", rectRx)
		.attr("ry", rectRy)
		.attr("x", xs(x))
		.attr("y", ys(y))
		.attr("width", xs(xmin+w))
		.attr("height", ys(ymin+h));
}

// https://github.com/d3/d3-scale/blob/master/README.md#schemeCategory20
// var color = d3.scaleOrdinal(d3.schemeCategory10);

for (var w=0; w<totWorkers; w++) {
	var worker = workers[wnames[w]];
	for (var j=0; j<worker.jobs.length; j++){
		var job = worker.jobs[j];

		var t1 = (new Date(job.time_start)).getTime();
		var t2 = (new Date(job.time_end)).getTime();
//		console.log("t1", t1, "t2", t2, "elapsed", t2-t1);

		var x = t1, y = DY*(w+0.2), dx=t2-t1, dy=DY*0.6;
//		console.log("x", x, "y", y, "dx", dx, "dy", dy);
		var className = "success";
		if (job.level == "error"){
			className = "error";
		} else if (job.msg == "SKIP"){
			className = "skip";
		}
		color = d3.schemeCategory10[stocks[job.stock]]

		if (dx > 0){
			rrectColor(className, color, x, y, dx, dy);
			svg.append("text")
				.attr("x", xs(x)+8)
				.attr("y", ys(y+4))
				.attr("font-family", "sans-serif")
				.attr("font-size", "10px")
				.attr("text-anchor", "left")
				.attr("fill", "white")
				.text(job.stock);
		}

	}

	svg.append("text")
		.attr("x", 0)
		.attr("y", ys(y-1))
		.attr("font-family", "sans-serif")
		.attr("font-size", "10px")
		.attr("text-anchor", "left")
		.attr("fill", "black")
		.text(wnames[w]);
}


// ------------------------

</script>
	</body>
</html>
